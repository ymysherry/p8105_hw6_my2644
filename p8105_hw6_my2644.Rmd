---
title: "p8105_hw6_my2644"
author: "ymysherry"
date: "12/9/2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
library(p8105.datasets)
library(mgcv)
```
## Problem 1


```{r}
homicide_df =
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>%
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1
    )
  ) %>%
  filter(
        victim_race %in% c("White", "Black"),
  city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```


start with one city



```{r}
baltimore_df= 
    homicide_df %>%
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_race + victim_sex,
    data = baltimore_df,
    family = binomial()) %>%
  broom::tidy() %>%
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>%
  select(term, OR, starts_with("CI")) %>%
  knitr::kable(digits = 3)
```


Try this across cities.

```{r}
models_results_df = 
  homicide_df %>%
  nest(data = -city_state) %>%
  mutate(
     models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>%
  select(city_state, results) %>%
  unnest(results) %>%
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>%
  select(city_state, term, OR, starts_with("CI"))
```


```{r}
models_results_df %>%
  filter(term == "victim_sexMale") %>%
  mutate(city_state = fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Problem 2
tidy the birthweight dataset:
```{r}
bweight_df = 
  read_csv("data/birthweight.csv") %>%
  drop_na() %>%
  janitor::clean_names() %>%
  mutate(babysex = as.factor(babysex),
         malform = as.factor(malform),
         )
```

Fit a model:

 I started by the hypothesis that baby's birth weight is associated with a number of predictors including: baby's sex,presence of malformations that could affect weight (0 = absent, 1 = present), average number of cigarettes smoked per day during pregnancy,gestational age in weeks, mother’s age at delivery (years), mother’s pre-pregnancy BMI. The raw linear model only includes coefficients of main effects.

```{r}
model_fit = lm(bwt ~ babysex + malform + gaweeks + momage + ppbmi, data = bweight_df) %>%
  broom::tidy()
```

At the significance level of 0.05, there are sufficient evidence to conclude that malform is not a significant predictor for baby's birthweight. Therefore   malform is excluded from my raw model. Rerun the model with remaining predictors:

```{r}
model1_fit = lm(bwt ~ babysex + gaweeks + momage + ppbmi, data = bweight_df)
```

The estimated correlation coefficients all have p-value<0.05, indicating all predictors are significant at alpha=0.05. Now create a ggplot of model residuals against fitted-values.

```{r}
bweight_df %>%
  modelr::add_residuals(model1_fit) %>%
  modelr::add_predictions(model1_fit) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point()
```

Build the second using length at birth and gestational age as predictors (main effects only).
Build the third model using head circumference, length, sex, and all interactions (including the three-way interaction) between these.

```{r}
model2_fit = lm(bwt ~ blength + gaweeks, data = bweight_df)
model3_fit = lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex + bhead * blength * babysex, data = bweight_df)
```
